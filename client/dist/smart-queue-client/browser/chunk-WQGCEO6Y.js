import{a as q,b as x,c as z}from"./chunk-MH7KJOTP.js";import{a as N}from"./chunk-SF2N4QN7.js";import{h as V}from"./chunk-7VCFE4OG.js";import{a as j}from"./chunk-NYQL35S2.js";import{$a as i,Bb as P,Gb as A,Ia as g,Jb as I,Ka as S,Ma as T,Na as E,Oa as m,P as C,Qa as M,Ra as w,Sa as r,Ta as n,U as k,Va as _,Wa as f,Xa as l,Y as b,ab as d,bb as v,cb as y,ea as u,fa as p,hb as O,ua as a,va as h}from"./chunk-VBPBWIK6.js";var $=(()=>{class t{constructor(e){this.http=e,this.apiUrl=`${I.apiUrl}/admin`}callNextTicket(e){return this.http.post(`${this.apiUrl}/next`,{serviceType:e})}startServing(){return this.http.post(`${this.apiUrl}/serve`,{})}completeTicket(e){return this.http.post(`${this.apiUrl}/complete`,{notes:e})}markNoShow(){return this.http.post(`${this.apiUrl}/no-show`,{})}getAgents(){return this.http.get(`${this.apiUrl}/agents`)}static{this.\u0275fac=function(c){return new(c||t)(k(A))}}static{this.\u0275prov=C({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();var W=(t,s)=>s._id;function F(t,s){if(t&1&&(r(0,"span",4),i(1),n()),t&2){let e=l();a(),v("Guichet ",e.agent==null?null:e.agent.counterNumber,"")}}function B(t,s){if(t&1&&(r(0,"p",18)(1,"span",3),i(2,"person"),n(),i(3),n()),t&2){let e=l(2);a(3),v(" ",e.currentTicket.customerName," ")}}function G(t,s){if(t&1){let e=_();r(0,"button",23),f("click",function(){u(e);let o=l(2);return p(o.startServing())}),r(1,"span",3),i(2,"play_arrow"),n(),i(3," Commencer "),n()}}function H(t,s){if(t&1){let e=_();r(0,"button",24),f("click",function(){u(e);let o=l(2);return p(o.completeTicket())}),r(1,"span",3),i(2,"check"),n(),i(3," Terminer "),n()}}function R(t,s){if(t&1){let e=_();r(0,"div",11)(1,"div",16),i(2),n(),r(3,"span"),i(4),n(),r(5,"p",17),i(6),n(),g(7,B,4,1,"p",18),r(8,"div",19),g(9,G,4,0,"button",20)(10,H,4,0,"button",21),r(11,"button",22),f("click",function(){u(e);let o=l();return p(o.markNoShow())}),r(12,"span",3),i(13,"person_off"),n(),i(14," Absent "),n()()()}if(t&2){let e=l();a(2),d(e.currentTicket.ticketNumber),a(),E("badge ",e.getStatusClass(e.currentTicket.status),""),a(),v(" ",e.getStatusLabel(e.currentTicket.status)," "),a(2),d(e.getServiceLabel(e.currentTicket.serviceType)),a(),m(7,e.currentTicket.customerName?7:-1),a(2),m(9,e.currentTicket.status==="called"?9:-1),a(),m(10,e.currentTicket.status==="serving"?10:-1)}}function Y(t,s){if(t&1){let e=_();r(0,"div",25)(1,"span",3),i(2,"hourglass_empty"),n(),r(3,"p"),i(4,"Aucun ticket en cours"),n(),r(5,"button",26),f("click",function(){u(e);let o=l();return p(o.callNext())}),r(6,"span",3),i(7),n(),i(8," Appeler suivant "),n()()}if(t&2){let e=l();a(5),S("disabled",e.loading),a(2),d(e.loading?"sync":"campaign")}}function J(t,s){if(t&1&&(r(0,"div",12),i(1),n()),t&2){let e=l();a(),d(e.error)}}function K(t,s){if(t&1&&(r(0,"div",28)(1,"span",29),i(2),n(),r(3,"div",30)(4,"span",31),i(5),n(),r(6,"span",32),i(7),n()(),r(8,"span",33),i(9),n()()),t&2){let e=s.$implicit,c=s.$index,o=l(2);T("priority",e.priority>0),a(2),d(c+1),a(3),d(e.ticketNumber),a(2),d(o.getServiceLabel(e.serviceType)),a(2),v("",o.getWaitTime(e)," min")}}function Q(t,s){if(t&1&&(r(0,"div",15),M(1,K,10,6,"div",27,W),n()),t&2){let e=l();a(),w(e.waitingTickets)}}function X(t,s){t&1&&(r(0,"p",34),i(1,"Aucun ticket en attente"),n())}var ce=(()=>{class t{constructor(e,c,o,D){this.authService=e,this.ticketService=c,this.adminService=o,this.socketService=D,this.agent=null,this.currentTicket=null,this.waitingTickets=[],this.loading=!1,this.error="",this.subscriptions=[]}ngOnInit(){this.agent=this.authService.agent(),this.loadData(),this.agent&&(this.socketService.setAgentOnline(this.agent._id,this.agent.services),this.agent.services&&this.agent.services.length>0&&this.agent.services.forEach(e=>{this.socketService.joinService(e)}),console.log("\u2705 Agent console initialized for services:",this.agent.services)),this.subscriptions.push(this.socketService.onTicketCreated().subscribe(e=>{this.agent?.services?.includes(e.serviceType)&&(console.log("\u{1F4E9} New ticket for my service:",e.ticketNumber),this.loadWaitingTickets())}),this.socketService.onTicketUpdated().subscribe(e=>{this.currentTicket&&e._id===this.currentTicket._id&&(this.currentTicket=e),this.agent?.services?.includes(e.serviceType)&&this.loadWaitingTickets()}))}ngOnDestroy(){this.agent&&(this.socketService.setAgentOffline(this.agent._id,this.agent.services),this.agent.services&&this.agent.services.length>0&&this.agent.services.forEach(e=>{this.socketService.leaveService(e)})),this.subscriptions.forEach(e=>e.unsubscribe())}loadData(){this.authService.getMe().subscribe({next:e=>{e.data&&(this.agent=e.data,this.currentTicket=e.data.currentTicket||null)},error:e=>{console.error("\u274C Error loading agent data:",e),this.error="Erreur lors du chargement des donn\xE9es"}}),this.loadWaitingTickets()}loadWaitingTickets(){if(!this.agent||!this.agent.services||this.agent.services.length===0){console.warn("\u26A0\uFE0F No services assigned to agent"),this.waitingTickets=[];return}this.ticketService.getWaitingTickets().subscribe({next:e=>{e.data&&(this.waitingTickets=e.data,console.log(`\u{1F4CB} Loaded ${this.waitingTickets.length} waiting tickets for my services`))},error:e=>{console.error("\u274C Error loading waiting tickets:",e)}})}callNext(){this.loading=!0,this.error="",this.adminService.callNextTicket().subscribe({next:e=>{this.loading=!1,e.success&&e.data?(this.currentTicket=e.data,this.loadWaitingTickets(),console.log("\u2705 Called ticket:",e.data.ticketNumber)):this.error=e.message||"Aucun ticket en attente"},error:e=>{this.loading=!1;let c=e.error?.message||"Erreur lors de l'appel du ticket";this.error=c,console.error("\u274C Error calling next ticket:",c)}})}startServing(){this.adminService.startServing().subscribe({next:e=>{e.data&&(this.currentTicket=e.data,console.log("\u2705 Started serving ticket:",e.data.ticketNumber))},error:e=>{this.error=e.error?.message||"Erreur lors du d\xE9marrage du service",console.error("\u274C Error starting service:",e)}})}completeTicket(){this.adminService.completeTicket().subscribe({next:()=>{console.log("\u2705 Ticket completed"),this.currentTicket=null,this.loadData()},error:e=>{this.error=e.error?.message||"Erreur lors de la compl\xE9tion du ticket",console.error("\u274C Error completing ticket:",e)}})}markNoShow(){confirm("Marquer ce client comme absent ?")&&this.adminService.markNoShow().subscribe({next:()=>{console.log("\u2705 Ticket marked as no-show"),this.currentTicket=null,this.loadData()},error:e=>{this.error=e.error?.message||"Erreur lors du marquage d'absence",console.error("\u274C Error marking no-show:",e)}})}getWaitTime(e){let c=new Date(e.createdAt).getTime();return Math.round((Date.now()-c)/1e3/60)}getStatusLabel(e){return x[e]?.label||e}getStatusClass(e){return x[e]?.class||""}getServiceLabel(e){return q.find(c=>c.value===e)?.label||e}static{this.\u0275fac=function(c){return new(c||t)(h(N),h(z),h($),h(j))}}static{this.\u0275cmp=b({type:t,selectors:[["app-agent-console"]],standalone:!0,features:[O],decls:34,vars:8,consts:[[1,"agent-console"],[1,"console-header"],[1,"agent-info"],[1,"material-icons"],[1,"counter-badge"],[1,"stats-mini"],[1,"stat"],[1,"value"],[1,"label"],[1,"console-grid"],[1,"card","current-ticket-card"],[1,"current-ticket"],[1,"alert","alert-error"],[1,"card","queue-card"],[1,"count-badge"],[1,"queue-list"],[1,"ticket-number-large"],[1,"service-type"],[1,"customer-name"],[1,"ticket-actions"],[1,"btn","btn-success"],[1,"btn","btn-primary"],[1,"btn","btn-warning",3,"click"],[1,"btn","btn-success",3,"click"],[1,"btn","btn-primary",3,"click"],[1,"no-ticket"],[1,"btn","btn-primary","btn-lg",3,"click","disabled"],[1,"queue-item",3,"priority"],[1,"queue-item"],[1,"position"],[1,"ticket-info"],[1,"ticket-number"],[1,"service"],[1,"wait-time"],[1,"no-data"]],template:function(c,o){c&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1"),i(4,"Console Agent"),n(),r(5,"p")(6,"span",3),i(7,"person"),n(),i(8),g(9,F,2,1,"span",4),n()(),r(10,"div",5)(11,"div",6)(12,"span",7),i(13),n(),r(14,"span",8),i(15,"Servis aujourd'hui"),n()()()(),r(16,"div",9)(17,"div",10)(18,"h2")(19,"span",3),i(20,"confirmation_number"),n(),i(21," Ticket en cours "),n(),g(22,R,15,9,"div",11)(23,Y,9,2)(24,J,2,1,"div",12),n(),r(25,"div",13)(26,"h2")(27,"span",3),i(28,"queue"),n(),i(29," File d'attente "),r(30,"span",14),i(31),n()(),g(32,Q,3,0,"div",15)(33,X,2,0),n()()()),c&2&&(a(8),y(" ",o.agent==null?null:o.agent.firstName," ",o.agent==null?null:o.agent.lastName," "),a(),m(9,o.agent!=null&&o.agent.counterNumber?9:-1),a(4),d((o.agent==null?null:o.agent.ticketsServedToday)||0),a(9),m(22,o.currentTicket?22:23),a(2),m(24,o.error?24:-1),a(7),d(o.waitingTickets.length),a(),m(32,o.waitingTickets.length?32:33))},dependencies:[P,V],styles:[".agent-console[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto}.console-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding:1.5rem;background:linear-gradient(135deg,#1a365d,#2b6cb0);border-radius:12px;color:#fff}.agent-info[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin-bottom:.5rem}.agent-info[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;opacity:.9}.counter-badge[_ngcontent-%COMP%]{background:#fff3;padding:.25rem .75rem;border-radius:999px;font-size:.875rem}.stats-mini[_ngcontent-%COMP%]   .stat[_ngcontent-%COMP%]{text-align:right}.stats-mini[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]{display:block;font-size:2rem;font-weight:700}.stats-mini[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]{font-size:.875rem;opacity:.8}.console-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}.current-ticket-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%], .queue-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;color:#1a365d;margin-bottom:1.5rem}.current-ticket[_ngcontent-%COMP%]{text-align:center}.ticket-number-large[_ngcontent-%COMP%]{font-size:4rem;font-weight:700;color:#1a365d;letter-spacing:.05em}.service-type[_ngcontent-%COMP%]{color:#718096;margin:.5rem 0}.customer-name[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;color:#4a5568}.ticket-actions[_ngcontent-%COMP%]{display:flex;gap:1rem;justify-content:center;margin-top:1.5rem}.no-ticket[_ngcontent-%COMP%]{text-align:center;padding:2rem;color:#718096}.no-ticket[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:4rem;opacity:.3}.no-ticket[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:1rem 0}.count-badge[_ngcontent-%COMP%]{background:#e2e8f0;color:#1a365d;padding:.25rem .75rem;border-radius:999px;font-size:.875rem;margin-left:auto}.queue-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.queue-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;padding:1rem;background:#f7fafc;border-radius:8px;border-left:4px solid #e2e8f0}.queue-item.priority[_ngcontent-%COMP%]{border-left-color:#dd6b20}.position[_ngcontent-%COMP%]{width:28px;height:28px;background:#1a365d;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.875rem;font-weight:600}.ticket-info[_ngcontent-%COMP%]{flex:1}.ticket-number[_ngcontent-%COMP%]{font-weight:600;display:block}.service[_ngcontent-%COMP%]{font-size:.875rem;color:#718096}.wait-time[_ngcontent-%COMP%]{color:#718096;font-size:.875rem}.no-data[_ngcontent-%COMP%]{text-align:center;color:#a0aec0;padding:2rem}.alert-error[_ngcontent-%COMP%]{background:#fed7d7;color:#c53030;padding:1rem;border-radius:8px;margin-top:1rem;text-align:center}@media (max-width: 768px){.console-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}.console-header[_ngcontent-%COMP%]{flex-direction:column;text-align:center;gap:1rem}}"]})}}return t})();export{ce as AgentConsoleComponent};
